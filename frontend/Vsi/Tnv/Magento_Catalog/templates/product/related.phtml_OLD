<?php
/**
 * Copyright Â© Magento, Inc. All rights reserved.
 * See COPYING.txt for license details.
 */
use Magento\Framework\App\Action\Action;

// @codingStandardsIgnoreFile

?>
<?php
/**
 * Product list template
 *
 * @var $block \Magento\Catalog\Block\Product\ListProduct
 */
?>
<?php


$objectManager =  \Magento\Framework\App\ObjectManager::getInstance();
$_helper = $this->helper('Magento\Catalog\Helper\Output');
$cartHelper = $objectManager->get('\Magento\Checkout\Helper\Cart');
$_productCollection=$this->getItems();

?>


<?php if (!$_productCollection->count()): ?>
	<?php return; ?>
    <div class="message info empty"><div><?= /* @escapeNotVerified */ __('We can\'t find products matching the selection.') ?></div></div>
<?php else: ?>
    <?= $block->getToolbarHtml() ?>
    <?= $block->getAdditionalHtml() ?>
    <?php
    if ($block->getMode() == 'grid') {
        $viewMode = 'grid';
        $imageDisplayArea = 'category_page_grid';
        $showDescription = false;
        $templateType = \Magento\Catalog\Block\Product\ReviewRendererInterface::SHORT_VIEW;
    } else {
        $viewMode = 'list';
        $imageDisplayArea = 'category_page_list';
        $showDescription = true;
        $templateType = \Magento\Catalog\Block\Product\ReviewRendererInterface::FULL_VIEW;
    }
    /**
     * Position for actions regarding image size changing in vde if needed
     */
    $pos = $block->getPositioned();?>
    
	<div id="related_products">
		<p class="text-center"><b>Pair With These Products</b></p>
				<?php /** @var $_product \Magento\Catalog\Model\Product */ ?>
		<?php $i=1; foreach ($_productCollection as $_product): ?>
				
		<div>
				<div class="media">
					
					<div class="media-left">
                        <?php
						$productImage = $block->getImage($_product, $imageDisplayArea);
						if ($pos != null) {
							$position = ' style="left:' . $productImage->getWidth() . 'px;'
								. 'top:' . $productImage->getHeight() . 'px;"';
						}
						?>
						<?php // Product Image ?>
						<a href="<?= /* @escapeNotVerified */ $_product->getProductUrl() ?>" class="product photo product-item-photo" tabindex="-1">
							<?= $productImage->toHtml() ?>
						</a>
                    </div>
					
					
					<div class="media-body">
							<?php $_productNameStripped = $block->stripTags($_product->getName(), null, true); ?>
								<a class="name"
								   href="<?= /* @escapeNotVerified */ $_product->getProductUrl() ?>">
									<?= /* @escapeNotVerified */ $_helper->productAttribute($_product, $_product->getName(), 'name') ?>
								</a>
						
							<? /* @escapeNotVerified */ //$block->getProductPrice($_product) ?>
							<?= $block->getProductDetailsHtml($_product) ?>
							
							
							
							<div class="product-item-inner">
								<div class="product actions product-item-actions"<?= strpos($pos, $viewMode . '-actions') ? $position : '' ?>>
									<div class="actions-primary"<?= strpos($pos, $viewMode . '-primary') ? $position : '' ?>>
										<?php if ($_product->isSaleable()): ?>
											<?php $postParams = $block->getAddToCartPostParams($_product); ?>
											<form id="add_to_cart_form" data-role="tocart-form" data-product-sku="<?= $block->escapeHtml($_product->getSku()) ?>" action="<?= /* @NoEscape */ /*$postParams['action']*/ $cartHelper->getAddUrl($_product) ?>" method="post">
												<input type="hidden" name="product" value="<?= /* @escapeNotVerified */ $postParams['data']['product'] ?>">
												<input type="hidden" name="<?= /* @escapeNotVerified */ Action::PARAM_NAME_URL_ENCODED ?>" value="<?= /* @escapeNotVerified */ $postParams['data'][Action::PARAM_NAME_URL_ENCODED] ?>">
												<?= $block->getBlockHtml('formkey') ?>
												
												
												<div>
													<?php
														$_objectManager = \Magento\Framework\App\ObjectManager::getInstance();
														$customOptions = $_objectManager->get('Magento\Catalog\Model\Product\Option')->getProductOptionCollection($_product);
														$optStr = "";	
														foreach($customOptions as $optionKey => $optionVal):
															$optStr .= "<div class='custom-options'>";
																$optStr .= "<select class='selectpicker' name='options[".$optionVal->getId()."]'>";
																$inStock  = true;

																foreach($optionVal->getValues() as $valuesKey => $valuesVal) {
						
																    	
																   if($valuesVal->getInStock()=='0'){
																   	     $inStock = false;
																        $optStr .= "<option data-stock='outofstock' value='".$valuesVal->getId()."' >$".number_format($valuesVal->getPrice(),2).'&nbsp;&nbsp;&nbsp;'.$valuesVal->getTitle()." Out of Stock</option>";
																    }else{
																        $inStock = true;
																        $optStr .= "<option data-stock='instock' value='".$valuesVal->getId()."'>$".number_format($valuesVal->getPrice(),2).'&nbsp;&nbsp;&nbsp;'.$valuesVal->getTitle()."</option>";
																    }
											        		    }

															$optStr .= "</select></div>";
														endforeach;
														   echo($optStr );
													?>
												</div>
												
												<div>
													<?php echo $this->getLayout()->createBlock("Milople\Recurringandsubscriptionpayments\Block\Product\View\Recurringoptions")->setTemplate("Milople_Recurringandsubscriptionpayments::product/view/subscription_productview.phtml")->toHtml();?>
												</div>
												<?php if($inStock): ?>
												
												<div class="btn-group addtocart" role="group" aria-label="...">
													  <button type="button" class="btn action primary btn_minus">-</button>
													  <input type="number"
																	   name="qty"
																	   value="1"
																	   title="<?= /* @escapeNotVerified */ __('Qty') ?>"
																	   class="input-text qty"
																	   data-validate="<?= $block->escapeHtml(json_encode($block->getQuantityValidators())) ?>"
																	   />
													  <button type="button" class="btn action primary btn_plus">+</button>
													<button type="submit"
															title="<?= $block->escapeHtml(__('Add to Cart')) ?>"
															class="action tocart primary">
														<span><?= /* @escapeNotVerified */ __('Add to Cart') ?></span>
													</button>
												</div>
												
												<?php endif;?>
												
												<div>
													
												</div>
											</form>
										<?php else: ?>
											<?php if ($_product->isAvailable()): ?>
												<div class="stock available"><span><?= /* @escapeNotVerified */ __('In stock') ?></span></div>
											<?php else: ?>
												<div class="stock unavailable"><span><?= /* @escapeNotVerified */ __('Out of stock') ?></span></div>
											<?php endif; ?>
										<?php endif; ?>
									</div>
									<div data-role="add-to-links" class="actions-secondary"<?= strpos($pos, $viewMode . '-secondary') ? $position : '' ?>>
										<?php if ($addToBlock = $block->getChildBlock('addto')): ?>
											<?= $addToBlock->setProduct($_product)->getChildHtml() ?>
										<?php endif; ?>
									</div>
								</div>
								
								
							</div>
						</div>
				
				</div>
				</div>
				<?php endforeach; ?>
			</div>
    <?= $block->getToolbarHtml() ?>
    <?php if (!$block->isRedirectToCartEnabled()) : ?>
        <script type="text/x-magento-init">
        {
            "[data-role=tocart-form], .form.map.checkout": {
                "catalogAddToCart": {
                    "product_sku": "<?= /* @NoEscape */ $_product->getSku() ?>"
                }
            }
        }
        </script>
    <?php endif; ?>
<?php endif; ?>


<script>
require(['jquery', 'jquery/ui'], function($){ 
    jQuery(document).on('click','[data-stock=outofstock]',function(){
        jQuery(this).parent('#add_to_cart_form').find('.addtocart').hide();
    })
    
    jQuery(document).on('click','[data-stock=instock]',function(){
        jQuery(this).parent('#add_to_cart_form').find('.addtocart').show();
    })
 });
</script>